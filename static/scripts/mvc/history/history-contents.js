"use strict";define(["mvc/base/controlled-fetch-collection","mvc/history/hda-model","mvc/history/hdca-model","mvc/history/history-preferences","mvc/base-mvc","utils/ajax-queue"],function(t,e,i,n,r,o){var s=t.PaginatedCollection;return{HistoryContents:s.extend(r.LoggableMixin).extend({_logNamespace:"history",model:function(t,n){if("dataset"===t.history_content_type)return new e.HistoryDatasetAssociation(t,n);if("dataset_collection"===t.history_content_type){switch(t.collection_type){case"list":return new i.HistoryListDatasetCollection(t,n);case"paired":return new i.HistoryPairDatasetCollection(t,n);case"list:paired":return new i.HistoryListPairedDatasetCollection(t,n);case"list:list":return new i.HistoryListOfListsDatasetCollection(t,n)}var r="Unknown collection_type: "+t.collection_type;return console.warn(r,t),{validationError:r}}return{validationError:"Unknown history_content_type: "+t.history_content_type}},limitPerPage:500,limitPerProgressiveFetch:500,order:"hid",urlRoot:Galaxy.root+"api/histories",url:function(){return this.urlRoot+"/"+this.historyId+"/contents"},initialize:function(t,e){e=e||{},s.prototype.initialize.call(this,t,e),this.history=e.history||null,this.setHistoryId(e.historyId||null),this.includeDeleted=e.includeDeleted||this.includeDeleted,this.includeHidden=e.includeHidden||this.includeHidden,this.model.prototype.idAttribute="type_id"},setHistoryId:function(t){this.historyId=t,this._setUpWebStorage()},_setUpWebStorage:function(t){if(this.historyId)return this.storage=new n.HistoryPrefs({id:n.HistoryPrefs.historyStorageKey(this.historyId)}),this.trigger("new-storage",this.storage,this),this.on({"include-deleted":function(t){this.storage.includeDeleted(t)},"include-hidden":function(t){this.storage.includeHidden(t)}}),this.includeDeleted=this.storage.includeDeleted()||!1,this.includeHidden=this.storage.includeHidden()||!1,this},comparators:_.extend(_.clone(s.prototype.comparators),{name:r.buildComparator("name",{ascending:!0}),"name-dsc":r.buildComparator("name",{ascending:!1}),hid:r.buildComparator("hid",{ascending:!1}),"hid-asc":r.buildComparator("hid",{ascending:!0})}),running:function(){return this.filter(function(t){return!t.inReadyState()})},runningAndActive:function(){return this.filter(function(t){return!t.inReadyState()&&t.get("visible")&&!t.get("deleted")})},getByHid:function(t){return this.findWhere({hid:t})},haveDetails:function(){return this.all(function(t){return t.hasDetails()})},hidden:function(){return this.filter(function(t){return t.hidden()})},deleted:function(){return this.filter(function(t){return t.get("deleted")})},visibleAndUndeleted:function(){return this.filter(function(t){return t.get("visible")&&!t.get("deleted")})},setIncludeDeleted:function(t,e){if(_.isBoolean(t)&&t!==this.includeDeleted){if(this.includeDeleted=t,_.result(e,"silent"))return;this.trigger("include-deleted",t,this)}},setIncludeHidden:function(t,e){if(_.isBoolean(t)&&t!==this.includeHidden){if(this.includeHidden=t,e=e||{},_.result(e,"silent"))return;this.trigger("include-hidden",t,this)}},fetch:function(t){if(t=t||{},this.historyId&&!t.details){var e=n.HistoryPrefs.get(this.historyId).toJSON();_.isEmpty(e.expandedIds)||(t.details=_.values(e.expandedIds).join(","))}return s.prototype.fetch.call(this,t)},_buildFetchData:function(t){return _.extend(s.prototype._buildFetchData.call(this,t),{v:"dev"})},_fetchParams:s.prototype._fetchParams.concat(["v","details"]),_buildFetchFilters:function(t){var e=s.prototype._buildFetchFilters.call(this,t)||{},i={};return this.includeDeleted||(i.deleted=!1,i.purged=!1),this.includeHidden||(i.visible=!0),_.defaults(e,i)},getTotalItemCount:function(){return this.history.contentsShown()},fetchUpdated:function(t,e){return t&&((e=e||{filters:{}}).remove=!1,e.filters={"update_time-ge":t.toISOString(),visible:""}),this.fetch(e)},fetchDeleted:function(t){var e=this;return(t=t||{}).filters=_.extend(t.filters,{deleted:!0,purged:void 0}),t.remove=!1,e.trigger("fetching-deleted",e),e.fetch(t).always(function(){e.trigger("fetching-deleted-done",e)})},fetchHidden:function(t){var e=this;return(t=t||{}).filters=_.extend(t.filters,{visible:!1}),t.remove=!1,e.trigger("fetching-hidden",e),e.fetch(t).always(function(){e.trigger("fetching-hidden-done",e)})},fetchAllDetails:function(t){var e={details:"all"};return(t=t||{}).data=_.extend(t.data||{},e),this.fetch(t)},fetchCollectionCounts:function(t){return t=t||{},t.keys=["type_id","element_count"].join(","),t.filters=_.extend(t.filters||{},{history_content_type:"dataset_collection"}),t.remove=!1,this.fetch(t)},_filterAndUpdate:function(t,e){var i=this,n=i.model.prototype.idAttribute,r=[e];return i.fetch({filters:t,remove:!1}).then(function(t){return t=t.reduce(function(t,e,r){var o=i.get(e[n]);return o?t.concat(o):t},[]),i.ajaxQueue("save",r,t)})},ajaxQueue:function(t,e,i){return i=i||this.models,new o.AjaxQueue(i.slice().reverse().map(function(i,n){var r=_.isString(t)?i[t]:t;return function(){return r.apply(i,e)}})).deferred},progressivelyFetchDetails:function(t){function i(e){e=e||0;var a=_.extend(_.clone(t),{view:"summary",keys:s,limit:o,offset:e,reset:0===e,remove:!1});_.defer(function(){r.fetch.call(r,a).fail(n.reject).done(function(t){n.notify(t,o,e),t.length!==o?(r.allFetched=!0,n.resolve(t,o,e)):i(e+o)})})}t=t||{};var n=jQuery.Deferred(),r=this,o=t.limitPerCall||r.limitPerProgressiveFetch,s=e.HistoryDatasetAssociation.prototype.searchAttributes.join(",");return i(),n},isCopyable:function(t){var e=["HistoryDatasetAssociation","HistoryDatasetCollectionAssociation"];return _.isObject(t)&&t.id&&_.contains(e,t.model_class)},copy:function(t){var e,i,n;_.isString(t)?(e=t,n="hda",i="dataset"):(e=t.id,n={HistoryDatasetAssociation:"hda",LibraryDatasetDatasetAssociation:"ldda",HistoryDatasetCollectionAssociation:"hdca"}[t.model_class]||"hda",i="hdca"===n?"dataset_collection":"dataset");var r=this,o=jQuery.ajax(this.url(),{method:"POST",contentType:"application/json",data:JSON.stringify({content:e,source:n,type:i})}).done(function(t){r.add([t],{parse:!0})}).fail(function(t,s,a){r.trigger("error",r,o,{},"Error copying contents",{type:i,id:e,source:n})});return o},createHDCA:function(t,e,i,n,r){return this.model({history_content_type:"dataset_collection",collection_type:e,history_id:this.historyId,name:i,hide_source_items:n||!1,element_identifiers:t}).save(r)},haveSearchDetails:function(){return this.allFetched&&this.all(function(t){return _.has(t.attributes,"annotation")})},matches:function(t){return this.filter(function(e){return e.matches(t)})},clone:function(){var t=Backbone.Collection.prototype.clone.call(this);return t.historyId=this.historyId,t},toString:function(){return["HistoryContents(",[this.historyId,this.length].join(),")"].join("")}})}});
//# sourceMappingURL=../../../maps/mvc/history/history-contents.js.map
