"use strict";define(["mvc/dataset/dataset-model","mvc/dataset/dataset-list","mvc/ui/ui-modal","mvc/base-mvc","utils/localization"],function(e,t,s,l,i){function a(e,t,s){function l(e,t){for(var s in t)if(t.hasOwnProperty(s)&&e[s]!==t[s])return!1;return!0}return e.filter(function(e){return console.debug(e),!e.deleted&&e.visible&&(!s||void 0===e.collection_type)&&l(e,t)})}var n=function(l,n){(n=_.defaults(n||{},{datasetsOnly:!0,where:{state:"ok"},multiselect:!1,selected:[]})).title=n.title||i(n.multiselect?"Choose datasets:":"Choose a dataset:");var o,c,d,r=jQuery.Deferred();return(l=(n.filter||a)(l,n.where,n.datasetsOnly)).length?(n.multiselect&&((d={})[i("Ok")]=function(){r.resolve(c.getSelectedModels().map(function(e){return e.toJSON()}))}),(o=new s.View({height:"auto",buttons:d,closing_events:!0,closing_callback:function(){r.resolve(null)},body:['<div class="list-panel"></div>'].join("")})).$(".modal-header").remove(),o.$(".modal-footer").css("margin-top","0px"),(c=new t.DatasetList({title:n.title,subtitle:n.subtitle||i(["Click the checkboxes on the right to select datasets. ","Click the datasets names to see their details. "].join("")),el:o.$body.find(".list-panel"),selecting:!0,selected:n.selected,collection:new e.DatasetAssociationCollection(l)})).once("rendered:initial",function(){o.show(),o.$el.addClass("dataset-choice-modal")}),n.multiselect||(c.on("rendered",function(){c.$(".list-actions").hide()}),c.on("view:selected",function(e){r.resolve([e.model.toJSON()])})),c.render(0),r.always(function(){o.hide()})):r.reject("No matches found")},o=Backbone.View.extend(l.LoggableMixin).extend({_logNamespace:"dataset",className:"dataset-choice",initialize:function(e){this.debug(this+"(DatasetChoice).initialize:",e),this.label=void 0!==e.label?i(e.label):"",this.where=e.where,this.datasetsOnly=void 0===e.datasetsOnly||e.datasetsOnly,this.datasetJSON=e.datasetJSON||[],this.selected=e.selected||[],this._setUpListeners()},_setUpListeners:function(){},render:function(){var e=this.toJSON();return this.$el.html(this._template(e)),this.$(".selected").replaceWith(this._renderSelected(e)),this},_template:function(e){return _.template(["<label>",'<span class="prompt"><%- label %></span>','<div class="selected"></div>',"</label>"].join(""))(e)},_renderSelected:function(e){return e.selected.length?$(_.template(['<div class="selected">','<span class="title"><%- selected.hid %>: <%- selected.name %></span>','<span class="subtitle">',"<i><%- selected.misc_blurb %></i>","<i>",i("format")+": ","<%- selected.file_ext %></i>","<i><%- selected.misc_info %></i>","</span>","</div>"].join(""),{variable:"selected"})(e.selected[0])):$(['<span class="none-selected-msg">(',i("click to select a dataset"),")</span>"].join(""))},toJSON:function(){var e=this;return{label:e.label,datasets:e.datasetJSON,selected:_.compact(_.map(e.selected,function(t){return _.findWhere(e.datasetJSON,{id:t})}))}},events:{click:"chooseWithModal"},chooseWithModal:function(){var e=this;return this._createModal().done(function(t){t?(e.selected=_.pluck(t,"id"),e.trigger("selected",e,t),e.render()):e.trigger("cancelled",e)}).fail(function(){e.trigger("error",e,arguments)})},_createModal:function(){return new n(this.datasetJSON,this._getModalOptions())},_getModalOptions:function(){return{title:this.label,multiselect:!1,selected:this.selected,where:this.where,datasetsOnly:this.datasetsOnly}},toString:function(){return"DatasetChoice("+this.selected+")"}}),c=o.extend({className:o.prototype.className+" multi",cells:{hid:i("History #"),name:i("Name"),misc_blurb:i("Summary"),file_ext:i("Format"),genome_build:i("Genome"),tags:i("Tags"),annotation:i("Annotation")},initialize:function(e){this.showHeaders=void 0===e.showHeaders||e.showHeaders,this.cells=e.cells||this.cells,o.prototype.initialize.call(this,e)},_renderSelected:function(e){return e.selected.length?$(_.template(['<table class="selected">',"<% if( json.showHeaders ){ %>","<thead><tr>","<% _.map( json.cells, function( val, key ){ %>","<th><%- val %></th>","<% }); %>","</tr></thead>","<% } %>","<tbody>","<% _.map( json.selected, function( selected ){ %>","<tr>","<% _.map( json.cells, function( val, key ){ %>",'<td class="cell-<%- key %>"><%- selected[ key ] %></td>',"<% }) %>","</tr>","<% }); %>","</tbody>","</table>"].join(""),{variable:"json"})(e)):$(['<span class="none-selected-msg">(',i("click to select a dataset"),")</span>"].join(""))},toJSON:function(){return _.extend(o.prototype.toJSON.call(this),{showHeaders:this.showHeaders,cells:this.cells})},_getModalOptions:function(){return _.extend(o.prototype._getModalOptions.call(this),{multiselect:!0})},toString:function(){return"DatasetChoice("+this.selected+")"}});return{DatasetChoiceModal:n,DatasetChoice:o,MultiDatasetChoice:c}});
//# sourceMappingURL=../../../maps/mvc/dataset/dataset-choice.js.map
