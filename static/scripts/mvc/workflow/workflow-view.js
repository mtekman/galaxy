"use strict";define("mvc/workflow/workflow-globals",{}),define(["utils/utils","mvc/workflow/workflow-globals","mvc/workflow/workflow-manager","mvc/workflow/workflow-canvas","mvc/workflow/workflow-node","mvc/workflow/workflow-icons","mvc/workflow/workflow-forms","mvc/ui/ui-misc","utils/async-save-text","libs/toastr","ui/editable-text"],function(o,t,e,i,n,a,s,r,l,w){function d(o){var t=$("#galaxy_tools").contents();0===t.length&&(t=$(document),$(this).removeClass("search_active"),t.find(".toolTitle").removeClass("search_match"),t.find(".toolSectionBody").hide(),t.find(".toolTitle").show(),t.find(".toolPanelLabel").show(),t.find(".toolSectionWrapper").each(function(){"recently_used_wrapper"!==$(this).attr("id")?$(this).show():$(this).hasClass("user_pref_visible")&&$(this).show()}),t.find("#search-no-results").hide(),t.find("#search-spinner").hide(),o&&t.find("#tool-search-query").val("search tools"))}function c(o,t){var e=a[t];if(e){var i=$('<i class="icon fa">&nbsp;</i>').addClass(e);o.before(i)}}return Backbone.View.extend({initialize:function(e){function n(){$.jStorage.set("overview-off",!1),$("#overview-border").css("right","0px"),$("#close-viewport").css("background-position","0px 0px")}function a(){$.jStorage.set("overview-off",!0),$("#overview-border").css("right","20000px"),$("#close-viewport").css("background-position","12px 0px")}var s=t.app=this;this.options=e,this.urls=e&&e.urls||{};var r=function(t,e){if(show_message("Saving workflow","progress"),s.workflow.check_changes_in_active_form(),!s.workflow.has_changes)return hide_modal(),void(e&&e());s.workflow.rectify_workflow_outputs(),o.request({url:Galaxy.root+"api/workflows/"+s.options.id,type:"PUT",data:{workflow:s.workflow.to_simple()},success:function(o){var t=$("<div/>").text(o.message);if(o.errors){t.addClass("warningmark");var i=$("<ul/>");$.each(o.errors,function(o,t){$("<li/>").text(t).appendTo(i)}),t.append(i)}else t.addClass("donemark");s.workflow.name=o.name,s.workflow.has_changes=!1,s.workflow.stored=!0,s.showWorkflowParameters(),o.errors?window.show_modal("Saving workflow",t,{Ok:hide_modal}):(e&&e(),hide_modal())},error:function(o){window.show_modal("Saving workflow failed.",o.err_msg,{Ok:hide_modal})}})};$("#tool-search-query").click(function(){$(this).focus(),$(this).select()}).keyup(function(){if($(this).css("font-style","normal"),this.value.length<3)d(!1);else if(this.value!=this.lastValue){$(this).addClass("search_active");var o=this.value;this.timer&&clearTimeout(this.timer),$("#search-spinner").show(),this.timer=setTimeout(function(){$.get(s.urls.tool_search,{q:o},function(o){if($("#search-no-results").hide(),$(".toolSectionWrapper").hide(),$(".toolSectionWrapper").find(".toolTitle").hide(),0!=o.length){var t=$.map(o,function(o,t){return"link-"+o});$(t).each(function(o,t){$("[id='"+t+"']").parent().addClass("search_match"),$("[id='"+t+"']").parent().show().parent().parent().show().parent().show()}),$(".toolPanelLabel").each(function(){for(var o=$(this),t=o.next(),e=!0;0!==t.length&&t.hasClass("toolTitle");){if(t.is(":visible")){e=!1;break}t=t.next()}e&&o.hide()})}else $("#search-no-results").show();$("#search-spinner").hide()},"json")},400)}this.lastValue=this.value}),this.canvas_manager=t.canvas_manager=new i(this,$("#canvas-viewport"),$("#overview")),this.reset(),this.datatypes=JSON.parse($.ajax({url:Galaxy.root+"api/datatypes",async:!1}).responseText),this.datatypes_mapping=JSON.parse($.ajax({url:Galaxy.root+"api/datatypes/mapping",async:!1}).responseText),this.ext_to_type=this.datatypes_mapping.ext_to_class_name,this.type_to_type=this.datatypes_mapping.class_to_classes,this._workflowLoadAjax(s.options.id,{success:function(o){s.reset(),s.workflow.from_simple(o,!0),s.workflow.has_changes=!1,s.workflow.fit_canvas_to_nodes(),s.scroll_to_nodes(),s.canvas_manager.draw_overview();var t="";_.each(o.steps,function(e,i){var n="";e.errors&&(n+="<li>"+e.errors+"</li>"),_.each(o.upgrade_messages[i],function(o){n+="<li>"+o+"</li>"}),n&&(t+="<li>Step "+(parseInt(i,10)+1)+": "+s.workflow.nodes[i].name+"<ul>"+n+"</ul></li>")}),t?window.show_modal("Issues loading this workflow","Please review the following issues, possibly resulting from tool upgrades or changes.<p><ul>"+t+"</ul></p>",{Continue:hide_modal}):hide_modal(),s.showWorkflowParameters()},beforeSubmit:function(o){show_message("Loading workflow","progress")}}),window.make_popupmenu&&make_popupmenu($("#workflow-options-button"),{Save:r,"Save As":function(){var o=$('<form><label style="display:inline-block; width: 100%;">Save as name: </label><input type="text" id="workflow_rename" style="width: 80%;" autofocus/><br><label style="display:inline-block; width: 100%;">Annotation: </label><input type="text" id="wf_annotation" style="width: 80%;" /></form>');window.show_modal("Save As a New Workflow",o,{OK:function(){var o=$("#workflow_rename").val().length>0?$("#workflow_rename").val():"SavedAs_"+s.workflow.name,t=$("#wf_annotation").val().length>0?$("#wf_annotation").val():"";$.ajax({url:s.urls.workflow_save_as,type:"POST",data:{workflow_name:o,workflow_annotation:t,workflow_data:function(){return JSON.stringify(s.workflow.to_simple())}}}).done(function(o){window.onbeforeunload=void 0,window.location=Galaxy.root+"workflow/editor?id="+o,hide_modal()}).fail(function(){hide_modal(),alert("Saving this workflow failed. Please contact this site's administrator.")})},Cancel:hide_modal})},Run:function(){window.location=Galaxy.root+"workflow/run?id="+s.options.id},"Edit Attributes":function(){s.workflow.clear_active_node()},"Auto Re-layout":function(){s.workflow.layout(),s.workflow.fit_canvas_to_nodes(),s.scroll_to_nodes(),s.canvas_manager.draw_overview()},Close:function(){if(s.workflow.check_changes_in_active_form(),workflow&&s.workflow.has_changes){var o=function(){window.onbeforeunload=void 0,window.document.location=s.urls.workflow_index};window.show_modal("Close workflow editor","There are unsaved changes to your workflow which will be lost.",{Cancel:hide_modal,"Save Changes":function(){r(null,o)}},{"Don't Save":o})}else window.document.location=s.urls.workflow_index}});var w=$.jStorage.get("overview-size");void 0!==w&&$("#overview-border").css({width:w,height:w}),$.jStorage.get("overview-off")?a():n(),$("#overview-border").bind("dragend",function(o,t){var e=$(this).offsetParent(),i=e.offset(),n=Math.max(e.width()-(t.offsetX-i.left),e.height()-(t.offsetY-i.top));$.jStorage.set("overview-size",n+"px")}),$("#close-viewport").click(function(){"0px"===$("#overview-border").css("right")?a():n()}),window.onbeforeunload=function(){if(workflow&&s.workflow.has_changes)return"There are unsaved changes to your workflow which will be lost."},this.options.workflows.length>0&&$("#left").find(".toolMenu").append(this._buildToolPanelWorkflows()),$("div.toolSectionBody").hide(),$("div.toolSectionTitle > span").wrap("<a href='#'></a>");var c=null;$("div.toolSectionTitle").each(function(){var o=$(this).next("div.toolSectionBody");$(this).click(function(){o.is(":hidden")?(c&&c.slideUp("fast"),c=o,o.slideDown("fast")):(o.slideUp("fast"),c=null)})}),l("workflow-name","workflow-name",s.urls.rename_async,"new_name"),$("#workflow-tag").click(function(){return $(".tag-area").click(),!1}),l("workflow-annotation","workflow-annotation",s.urls.annotate_async,"new_annotation",25,!0,4)},_buildToolPanelWorkflows:function(){var o=this,t=$('<div class="toolSectionWrapper"><div class="toolSectionTitle"><a href="#"><span>Workflows</span></a></div><div class="toolSectionBody"><div class="toolSectionBg"/></div></div>');return _.each(this.options.workflows,function(e){if(e.id!==o.options.id){var i=new r.ButtonIcon({icon:"fa fa-copy",cls:"ui-button-icon-plain",tooltip:"Copy and insert individual steps",onclick:function(){e.step_count<2?o.copy_into_workflow(e.id,e.name):Galaxy.modal.show({title:"Warning",body:"This will copy "+e.step_count+" new steps into your workflow.",buttons:{Cancel:function(){Galaxy.modal.hide()},Copy:function(){Galaxy.modal.hide(),o.copy_into_workflow(e.id,e.name)}}})}}),n=$("<a/>").attr("href","#").html(e.name).on("click",function(){o.add_node_for_subworkflow(e.latest_id,e.name)});t.find(".toolSectionBg").append($("<div/>").addClass("toolTitle").append(n).append(i.$el))}}),t},copy_into_workflow:function(o){var t=this;this._workflowLoadAjax(o,{success:function(o){t.workflow.from_simple(o,!1);var e="";$.each(o.upgrade_messages,function(o,i){e+="<li>Step "+(parseInt(o,10)+1)+": "+t.workflow.nodes[o].name+"<ul>",$.each(i,function(o,t){e+="<li>"+t+"</li>"}),e+="</ul></li>"}),e?window.show_modal("Subworkflow embedded with changes","Problems were encountered loading this workflow (possibly a result of tool upgrades). Please review the following parameters and then save.<ul>"+e+"</ul>",{Continue:hide_modal}):hide_modal()},beforeSubmit:function(o){show_message("Importing workflow","progress")}})},reset:function(){this.workflow&&this.workflow.remove_all(),this.workflow=t.workflow=new e(this,$("#canvas-container"))},scroll_to_nodes:function(){var o,t,e=$("#canvas-viewport"),i=$("#canvas-container");t=i.width()<e.width()?(e.width()-i.width())/2:0,o=i.height()<e.height()?(e.height()-i.height())/2:0,i.css({left:t,top:o})},_workflowLoadAjax:function(t,e){$.ajax(o.merge(e,{url:this.urls.load_workflow,data:{id:t,_:"true"},dataType:"json",cache:!1}))},_moduleInitAjax:function(t,e){var i=this;o.request({type:"POST",url:Galaxy.root+"api/workflows/build_module",data:e,success:function(o){t.init_field_data(o),t.update_field_data(o),i.workflow.activate_node(t)}})},add_node_for_tool:function(o,t){var e=this.workflow.create_node("tool",t,o);this._moduleInitAjax(e,{type:"tool",tool_id:o,_:"true"})},add_node_for_subworkflow:function(o,t){var e=this.workflow.create_node("subworkflow",t,o);this._moduleInitAjax(e,{type:"subworkflow",content_id:o,_:"true"})},add_node_for_module:function(o,t){var e=this.workflow.create_node(o,t);this._moduleInitAjax(e,{type:o,_:"true"})},display_pja:function(o,t){var e=this;$("#pja_container").append(get_pja_form(o,t)),$("#pja_container>.toolForm:last>.toolFormTitle>.buttons").click(function(){var o=$(this).closest(".toolForm",".action_tag").children(".action_tag:first").text();$(this).closest(".toolForm").remove(),delete e.workflow.active_node.post_job_actions[o],e.workflow.active_form_has_changes=!0})},display_pja_list:function(){return pja_list},display_file_list:function(o){var t="<select id='node_data_list' name='node_data_list'>";for(var e in o.output_terminals)t+="<option value='"+e+"'>"+e+"</option>";return t+="</select>"},new_pja:function(o,t,e){if(void 0===e.post_job_actions&&(e.post_job_actions={}),void 0===e.post_job_actions[o+t]){var i={};return i.action_type=o,i.output_name=t,e.post_job_actions[o+t]=null,e.post_job_actions[o+t]=i,display_pja(i,e),this.workflow.active_form_has_changes=!0,!0}return!1},showWorkflowParameters:function(){var t=/\$\{.+?\}/g,e=[],i=$("#workflow-parameters-container"),n=$("#workflow-parameters-box"),a="",s=[];$.each(this.workflow.nodes,function(i,n){n.config_form&&n.config_form.inputs&&o.deepeach(n.config_form.inputs,function(o){if("string"==typeof o.value){var e=o.value.match(t);e&&(s=s.concat(e))}}),n.post_job_actions&&$.each(n.post_job_actions,function(o,e){e.action_arguments&&$.each(e.action_arguments,function(o,e){var i=e.match(t);i&&(s=s.concat(i))})}),s&&$.each(s,function(o,t){-1===$.inArray(t,e)&&e.push(t)})}),e&&0!==e.length?($.each(e,function(o,t){a+="<div>"+t.substring(2,t.length-1)+"</div>"}),i.html(a),n.show()):(i.html(a),n.hide())},showAttributes:function(){$(".right-content").hide(),$("#edit-attributes").show()},showForm:function(o,t){var e="right-content",i=e+"-"+t.id,n=$("#"+e);if(o&&0==n.find("#"+i).length){var r=$('<div id="'+i+'" class="'+e+'"/>');if(o.node=t,o.workflow=this.workflow,o.datatypes=this.datatypes,o.icon=a[t.type],o.cls="ui-portlet-narrow",t){var l="tool"==t.type?"Tool":"Default";r.append(new s[l](o).form.$el),n.append(r)}else Galaxy.emit.debug("workflow-view::initialize()","Node not found in workflow.")}$("."+e).hide(),n.find("#"+i).show(),n.show(),n.scrollTop()},isSubType:function(o,t){return o=this.ext_to_type[o],t=this.ext_to_type[t],this.type_to_type[o]&&t in this.type_to_type[o]},prebuildNode:function(o,t,e){var i=this,a=$("<div class='toolForm toolFormInCanvas'/>"),s=$("<div class='toolFormTitle unselectable'><span class='nodeTitle'>"+t+"</div></div>");c(s.find(".nodeTitle"),o),a.append(s),a.css("left",$(window).scrollLeft()+20),a.css("top",$(window).scrollTop()+20),a.append($("<div class='toolFormBody'></div>"));var r=new n(this,{element:a});r.type=o,r.content_id=e;var l="<div><img height='16' align='middle' src='"+Galaxy.root+"static/images/loading_small_white_bg.gif'/> loading tool info...</div>";a.find(".toolFormBody").append(l);var w=$("<div class='buttons' style='float: right;'></div>");w.append($("<div/>").addClass("fa-icon-button fa fa-times").click(function(o){r.destroy()})),a.appendTo("#canvas-container");var d=$("#canvas-container").position(),f=$("#canvas-container").parent(),h=a.width(),u=a.height();return a.css({left:-d.left+f.width()/2-h/2,top:-d.top+f.height()/2-u/2}),w.prependTo(a.find(".toolFormTitle")),h+=w.width()+10,a.css("width",h),a.bind("dragstart",function(){i.workflow.activate_node(r)}).bind("dragend",function(){i.workflow.node_changed(this),i.workflow.fit_canvas_to_nodes(),i.canvas_manager.draw_overview()}).bind("dragclickonly",function(){i.workflow.activate_node(r)}).bind("drag",function(o,t){var e=$(this).offsetParent().offset(),i=t.offsetX-e.left,n=t.offsetY-e.top;$(this).css({left:i,top:n}),$(this).find(".terminal").each(function(){this.terminal.redraw()})}),r}})});
//# sourceMappingURL=../../../maps/mvc/workflow/workflow-view.js.map
