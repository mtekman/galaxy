"use strict";require(["utils/utils"],function(t){t.cssLoadFile("static/style/circster.css")}),define(["libs/underscore","libs/d3","viz/visualization","utils/config","mvc/ui/icon-button","libs/farbtastic"],function(t,e,a,n,i){var r=Backbone.Model.extend({is_visible:function(t,e){var a=t.getBoundingClientRect(),n=$("svg")[0].getBoundingClientRect();return!(a.right<0||a.left>n.right||a.bottom<0||a.top>n.bottom)}}),s={drawTicks:function(t,e,a,n,i){var r=t.append("g").selectAll("g").data(e).enter().append("g").selectAll("g").data(a).enter().append("g").attr("class","tick").attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+t.radius+",0)"}),s=[],o=[],l=function(t){return t.angle>Math.PI?"end":null};return i?(s=[0,0,0,-4],o=[4,0,"",".35em"],l=null):(s=[1,0,4,0],o=[0,4,".35em",""]),r.append("line").attr("x1",s[0]).attr("y1",s[1]).attr("x2",s[2]).attr("y1",s[3]).style("stroke","#000"),r.append("text").attr("x",o[0]).attr("y",o[1]).attr("dx",o[2]).attr("dy",o[3]).attr("text-anchor",l).attr("transform",n).text(function(t){return t.label})},formatNum:function(t,e){if(void 0===e&&(e=2),null===t)return null;var a=null;if(Math.abs(t)<1)a=t.toPrecision(e);else{var n=Math.round(t.toPrecision(e));(t=Math.abs(t))<1e3?a=n:t<1e6?a=Math.round((n/1e3).toPrecision(3)).toFixed(0)+"K":t<1e9&&(a=Math.round((n/1e6).toPrecision(3)).toFixed(0)+"M")}return a}},o=Backbone.Model.extend({}),l=Backbone.View.extend({className:"circster",initialize:function(t){this.genome=t.genome,this.label_arc_height=50,this.scale=1,this.circular_views=null,this.chords_views=null,this.model.get("drawables").on("add",this.add_track,this),this.model.get("drawables").on("remove",this.remove_track,this);var e=this.model.get("config");e.get("arc_dataset_height").on("change:value",this.update_track_bounds,this),e.get("track_gap").on("change:value",this.update_track_bounds,this)},get_circular_tracks:function(){return this.model.get("drawables").filter(function(t){return"DiagonalHeatmapTrack"!==t.get("track_type")})},get_chord_tracks:function(){return this.model.get("drawables").filter(function(t){return"DiagonalHeatmapTrack"===t.get("track_type")})},get_tracks_bounds:function(){var a=this.get_circular_tracks(),n=this.model.get("config").get_value("arc_dataset_height"),i=this.model.get("config").get_value("track_gap"),r=Math.min(this.$el.width(),this.$el.height())-20,s=r/2-a.length*(n+i)+i-this.label_arc_height,o=e.range(s,r/2,n+i);return t.map(o,function(t){return[t,t+n]})},render:function(){var t=this,a=t.$el.width(),n=t.$el.height(),i=this.get_circular_tracks(),r=this.get_chord_tracks(),s=t.model.get("config").get_value("total_gap"),l=this.get_tracks_bounds(),c=e.select(t.$el[0]).append("svg").attr("width",a).attr("height",n).attr("pointer-events","all").append("svg:g").call(e.behavior.zoom().on("zoom",function(){var a=e.event.scale;c.attr("transform","translate("+e.event.translate+") scale("+a+")"),t.scale!==a&&(t.zoom_drag_timeout&&clearTimeout(t.zoom_drag_timeout),t.zoom_drag_timeout=setTimeout(function(){},400))})).attr("transform","translate("+a/2+","+n/2+")").append("svg:g").attr("class","tracks");this.circular_views=i.map(function(e,a){var n=new _({el:c.append("g")[0],track:e,radius_bounds:l[a],genome:t.genome,total_gap:s});return n.render(),n}),this.chords_views=r.map(function(e){var a=new g({el:c.append("g")[0],track:e,radius_bounds:l[0],genome:t.genome,total_gap:s});return a.render(),a});var d=this.circular_views[this.circular_views.length-1].radius_bounds[1],h=[d,d+this.label_arc_height];this.label_track_view=new u({el:c.append("g")[0],track:new o,radius_bounds:h,genome:t.genome,total_gap:s}),this.label_track_view.render()},add_track:function(a){var n=this.model.get("config").get_value("total_gap");if("DiagonalHeatmapTrack"===a.get("track_type")){var i=this.circular_views[0].radius_bounds,r=new g({el:e.select("g.tracks").append("g")[0],track:a,radius_bounds:i,genome:this.genome,total_gap:n});r.render(),this.chords_views.push(r)}else{var s=this.get_tracks_bounds();t.each(this.circular_views,function(t,e){t.update_radius_bounds(s[e])}),t.each(this.chords_views,function(t){t.update_radius_bounds(s[0])});var o=this.circular_views.length,l=new _({el:e.select("g.tracks").append("g")[0],track:a,radius_bounds:s[o],genome:this.genome,total_gap:n});l.render(),this.circular_views.push(l)}},remove_track:function(e,a,n){var i=this.circular_views[n.index];this.circular_views.splice(n.index,1),i.$el.remove();var r=this.get_tracks_bounds();t.each(this.circular_views,function(t,e){t.update_radius_bounds(r[e])})},update_track_bounds:function(){var e=this.get_tracks_bounds();t.each(this.circular_views,function(t,a){t.update_radius_bounds(e[a])}),t.each(this.chords_views,function(t){t.update_radius_bounds(e[0])})}}),c=Backbone.View.extend({tagName:"g",initialize:function(t){this.bg_stroke="#ddd",this.loading_bg_fill="#ffc",this.bg_fill="#ddd",this.total_gap=t.total_gap,this.track=t.track,this.radius_bounds=t.radius_bounds,this.genome=t.genome,this.chroms_layout=this._chroms_layout(),this.data_bounds=[],this.scale=1,this.parent_elt=e.select(this.$el[0])},get_fill_color:function(){var t=this.track.get("config").get_value("block_color");return t||(t=this.track.get("config").get_value("color")),t},render:function(){var t=this.parent_elt,a=this.chroms_layout,n=e.svg.arc().innerRadius(this.radius_bounds[0]).outerRadius(this.radius_bounds[1]),i=t.selectAll("g").data(a).enter().append("svg:g").append("path").attr("d",n).attr("class","chrom-background").style("stroke",this.bg_stroke).style("fill",this.loading_bg_fill);i.append("title").text(function(t){return t.data.chrom});var r=this,s=r.track.get("data_manager"),o=!s||s.data_is_ready();$.when(o).then(function(){$.when(r._render_data(t)).then(function(){i.style("fill",r.bg_fill),r.render_labels()})})},render_labels:function(){},update_radius_bounds:function(t){this.radius_bounds=t;var a=e.svg.arc().innerRadius(this.radius_bounds[0]).outerRadius(this.radius_bounds[1]);this.parent_elt.selectAll("g>path.chrom-background").transition().duration(1e3).attr("d",a),this._transition_chrom_data(),this._transition_labels()},update_scale:function(a){var n=this.scale;if(this.scale=a,!(a<=n)){var i=this,s=new r;return this.parent_elt.selectAll("path.chrom-data").filter(function(t,e){return s.is_visible(this)}).each(function(n,r){var s,o=e.select(this),l=o.attr("chrom"),c=i.genome.get_chrom_region(l);i.track.get("data_manager").can_get_more_detailed_data(c)&&(s=i.track.get("data_manager").get_more_detailed_data(c,"Coverage",0,a),$.when(s).then(function(e){o.remove(),i._update_data_bounds();var a=t.find(i.chroms_layout,function(t){return t.data.chrom===l}),n=i.get_fill_color();i._render_chrom_data(i.parent_elt,a,e).style("stroke",n).style("fill",n)}))}),i}},_transition_chrom_data:function(){var a=this.track,n=this.chroms_layout,i=this.parent_elt.selectAll("g>path.chrom-data");if(i[0].length>0){var r=this;$.when(a.get("data_manager").get_genome_wide_data(this.genome)).then(function(s){var o=t.reject(t.map(s,function(t,e){var a=null,i=r._get_path_function(n[e],t);return i&&(a=i(t.data)),a}),function(t){return null===t}),l=a.get("config").get_value("color");i.each(function(t,a){e.select(this).transition().duration(1e3).style("stroke",l).style("fill",l).attr("d",o[a])})})}},_transition_labels:function(){},_update_data_bounds:function(t){this.data_bounds;this.data_bounds=t||this.get_data_bounds(this.track.get("data_manager").get_genome_wide_data(this.genome)),this._transition_chrom_data()},_render_data:function(e){var a=this,n=this.chroms_layout,i=this.track,r=$.Deferred();return $.when(i.get("data_manager").get_genome_wide_data(this.genome)).then(function(s){a.data_bounds=a.get_data_bounds(s),i.get("config").set_value("min_value",a.data_bounds[0],{silent:!0}),i.get("config").set_value("max_value",a.data_bounds[1],{silent:!0});var o=t.zip(n,s);t.each(o,function(t){var n=t[0],i=t[1];return a._render_chrom_data(e,n,i)});var l=a.get_fill_color();a.parent_elt.selectAll("path.chrom-data").style("stroke",l).style("fill",l),r.resolve(e)}),r},_render_chrom_data:function(t,e,a){},_get_path_function:function(t,e){},_chroms_layout:function(){var a=this.genome.get_chroms_info(),n=e.layout.pie().value(function(t){return t.len}).sort(null)(a),i=2*Math.PI*this.total_gap/a.length;return t.map(n,function(t,e){var a=t.endAngle-i;return t.endAngle=a>t.startAngle?a:t.startAngle,t})}}),u=c.extend({initialize:function(t){c.prototype.initialize.call(this,t),this.innerRadius=this.radius_bounds[0],this.radius_bounds[0]=this.radius_bounds[1],this.bg_stroke="#fff",this.bg_fill="#fff",this.min_arc_len=.05},_render_data:function(a){var n=this,i=a.selectAll("g");i.selectAll("path").attr("id",function(t){return"label-"+t.data.chrom}),i.append("svg:text").filter(function(t){return t.endAngle-t.startAngle>n.min_arc_len}).attr("text-anchor","middle").append("svg:textPath").attr("class","chrom-label").attr("xlink:href",function(t){return"#label-"+t.data.chrom}).attr("startOffset","25%").text(function(t){return t.data.chrom});var r=t.filter(this.chroms_layout,function(t){return t.endAngle-t.startAngle>n.min_arc_len});this.drawTicks(this.parent_elt,r,function(t){var a=(t.endAngle-t.startAngle)/t.value,i=e.range(0,t.value,25e6).map(function(e,i){return{radius:n.innerRadius,angle:e*a+t.startAngle,label:0===i?0:i%3?null:n.formatNum(e)}});return i.length<4&&(i[i.length-1].label=n.formatNum(Math.round((i[i.length-1].angle-t.startAngle)/a))),i},function(t){return t.angle>Math.PI?"rotate(180)translate(-16)":null})}});t.extend(u.prototype,s);var d=c.extend({initialize:function(t){c.prototype.initialize.call(this,t);var e=this.track.get("config");e.get("min_value").on("change:value",this._update_min_max,this),e.get("max_value").on("change:value",this._update_min_max,this),e.get("color").on("change:value",this._transition_chrom_data,this)},_update_min_max:function(){var t=this.track.get("config"),e=[t.get_value("min_value"),t.get_value("max_value")];this._update_data_bounds(e),this.parent_elt.selectAll(".min_max").text(function(t,a){return e[a]})},_quantile:function(t,a){return t.sort(e.ascending),e.quantile(t,a)},_render_chrom_data:function(t,e,a){var n=this._get_path_function(e,a);return n?t.datum(a.data).append("path").attr("class","chrom-data").attr("chrom",e.data.chrom).attr("d",n):null},_get_path_function:function(t,a){if("string"==typeof a||!a.data||0===a.data.length)return null;var n=e.scale.linear().domain(this.data_bounds).range(this.radius_bounds).clamp(!0),i=e.scale.linear().domain([0,a.data.length]).range([t.startAngle,t.endAngle]),r=e.svg.line.radial().interpolate("linear").radius(function(t){return n(t[1])}).angle(function(t,e){return i(e)});return e.svg.area.radial().interpolate(r.interpolate()).innerRadius(n(0)).outerRadius(r.radius()).angle(r.angle())},render_labels:function(){var e=this,a=this.drawTicks(this.parent_elt,[this.chroms_layout[0]],this._data_bounds_ticks_fn(),function(){return"rotate(90)"},!0).classed("min_max",!0);t.each(a,function(t){$(t).click(function(){new n.ConfigSettingCollectionView({collection:e.track.get("config")}).render_in_modal("Configure Track")})})},_transition_labels:function(){if(0!==this.data_bounds.length){var e=this,a=t.filter(this.chroms_layout,function(t){return t.endAngle-t.startAngle>.08}),n=t.filter(a,function(t,e){return e%3==0}),i=t.flatten(t.map(n,function(t){return e._data_bounds_ticks_fn()(t)}));this.parent_elt.selectAll("g.tick").data(i).transition().attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+t.radius+",0)"})}},_data_bounds_ticks_fn:function(){var t=this;return visibleChroms=0,function(e){return[{radius:t.radius_bounds[0],angle:e.startAngle,label:t.formatNum(t.data_bounds[0])},{radius:t.radius_bounds[1],angle:e.startAngle,label:t.formatNum(t.data_bounds[1])}]}},get_data_bounds:function(t){}});t.extend(d.prototype,s);var _=d.extend({get_data_bounds:function(e){var a=t.flatten(t.map(e,function(e){return e?t.map(e.data,function(t){return parseInt(t[1],10)||0}):0}));return[t.min(a),this._quantile(a,.98)||t.max(a)]}}),g=c.extend({render:function(){var a=this;$.when(a.track.get("data_manager").data_is_ready()).then(function(){$.when(a.track.get("data_manager").get_genome_wide_data(a.genome)).then(function(n){var i=[],r=a.genome.get_chroms_info();t.each(n,function(e,n){var s=r[n].chrom,o=t.map(e.data,function(t){var e=a._get_region_angle(s,t[1]),n=a._get_region_angle(t[3],t[4]);return{source:{startAngle:e,endAngle:e+.01},target:{startAngle:n,endAngle:n+.01}}});i=i.concat(o)}),a.parent_elt.append("g").attr("class","chord").selectAll("path").data(i).enter().append("path").style("fill",a.get_fill_color()).attr("d",e.svg.chord().radius(a.radius_bounds[0])).style("opacity",1)})})},update_radius_bounds:function(t){this.radius_bounds=t,this.parent_elt.selectAll("path").transition().attr("d",e.svg.chord().radius(this.radius_bounds[0]))},_get_region_angle:function(e,a){var n=t.find(this.chroms_layout,function(t){return t.data.chrom===e});return n.endAngle-(n.endAngle-n.startAngle)*(n.data.len-a)/n.data.len}});return{GalaxyApp:Backbone.View.extend({initialize:function(){var t=new a.Genome(galaxy_config.app.genome),e=new a.GenomeVisualization(galaxy_config.app.viz_config);e.get("config").add([{key:"arc_dataset_height",label:"Arc Dataset Height",type:"int",value:25,view:"circster"},{key:"track_gap",label:"Gap Between Tracks",type:"int",value:5,view:"circster"},{key:"total_gap",label:"Gap [0-1]",type:"float",value:.4,view:"circster",hidden:!0}]),new l({el:$("#center .unified-panel-body"),genome:t,model:e}).render(),$("#center .unified-panel-header-inner").append(galaxy_config.app.viz_config.title+" "+galaxy_config.app.viz_config.dbkey);var r=i.create_icon_buttons_menu([{icon_class:"plus-button",title:"Add tracks",on_click:function(){a.select_datasets({dbkey:e.get("dbkey")},function(t){e.add_tracks(t)})}},{icon_class:"gear",title:"Settings",on_click:function(){new n.ConfigSettingCollectionView({collection:e.get("config")}).render_in_modal("Configure Visualization")}},{icon_class:"disk--arrow",title:"Save",on_click:function(){Galaxy.modal.show({title:"Saving...",body:"progress"}),$.ajax({url:Galaxy.root+"visualization/save",type:"POST",dataType:"json",data:{id:e.get("vis_id"),title:e.get("title"),dbkey:e.get("dbkey"),type:"trackster",vis_json:JSON.stringify(e)}}).success(function(t){Galaxy.modal.hide(),e.set("vis_id",t.vis_id)}).error(function(){Galaxy.modal.show({title:"Could Not Save",body:"Could not save visualization. Please try again later.",buttons:{Cancel:function(){Galaxy.modal.hide()}}})})}},{icon_class:"cross-circle",title:"Close",on_click:function(){window.location=Galaxy.root+"visualizations/list"}}],{tooltip_config:{placement:"bottom"}});r.$el.attr("style","float: right"),$("#center .unified-panel-header-inner").append(r.$el),$(".menu-button").tooltip({placement:"bottom"})}})}});
//# sourceMappingURL=../../maps/viz/circster.js.map
