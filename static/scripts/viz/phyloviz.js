"use strict";define(["libs/d3","viz/visualization","mvc/dataset/data","mvc/ui/icon-button"],function(e,t,n,i){function o(){function t(e,n,i,o){var a=e.children,l=0,h=e.dist||c;return h=h>1?1:h,e.dist=h,e.y0=null!==o?o.y0+h*r:d,a?(a.forEach(function(o){o.parent=e,l+=t(o,n,i,e)}),e.x0=l/a.length):(e.x0=s*i,s+=1),e.x=e.x0,e.y=e.y0,e.x0}var n=this,i=e.layout.hierarchy().sort(null).value(null),o=360,a="Linear",l=18,r=200,s=0,c=.5,d=50;return n.leafHeight=function(e){return void 0===e?l:(l=e,n)},n.layoutMode=function(e){return void 0===e?a:(a=e,n)},n.layoutAngle=function(e){return void 0===e?o:isNaN(e)||e<0||e>360?n:(o=e,n)},n.separation=function(e){return void 0===e?r:(r=e,n)},n.links=function(t){return e.layout.tree().links(t)},n.nodes=function(e,r){"[object Array]"===toString.call(e)&&(e=e[0]);var c=i.call(n,e,r),d=[],h=0,u=0;return window._d=e,window._nodes=c,c.forEach(function(e){h=e.depth>h?e.depth:h,d.push(e)}),d.forEach(function(e){e.children||(u+=1,e.depth=h)}),l="Circular"===a?o/u:l,s=0,t(d[0],h,l,null),d},n}var a=Backbone.View.extend({className:"UserMenuBase",isAcceptableValue:function(e,t,n){var i=e.val(),o=e.attr("displayLabel")||e.attr("id").replace("phyloViz","");return function(e){return!isNaN(parseFloat(e))&&isFinite(e)}(i)?i>n?(alert(o+" is too large."),!1):!(i<t)||(alert(o+" is too small."),!1):(alert(o+" is not a number!"),!1)},hasIllegalJsonCharacters:function(e){return-1!==e.val().search(/"|'|\\/)&&(alert("Named fields cannot contain these illegal characters: double quote(\"), single guote('), or back slash(\\). "),!0)}}),l=t.Visualization.extend({defaults:{layout:"Linear",separation:250,leafHeight:18,type:"phyloviz",title:"Title",scaleFactor:1,translate:[0,0],fontSize:12,selectedNode:null,nodeAttrChangedTime:0},initialize:function(e){this.set("dataset",new n.Dataset({id:e.dataset_id}))},root:{},toggle:function(e){void 0!==e&&(e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null))},toggleAll:function(e){e.children&&0!==e.children.length&&(e.children.forEach(this.toggleAll),toggle(e))},getData:function(){return this.root},save:function(){function e(t){delete t.parent,t._selected&&delete t._selected,t.children&&t.children.forEach(e),t._children&&t._children.forEach(e)}e(this.root);var t=jQuery.extend(!0,{},this.attributes);return t.selectedNode=null,show_message("Saving to Galaxy","progress"),$.ajax({url:this.url(),type:"POST",dataType:"json",data:{config:JSON.stringify(t),type:"phyloviz"},success:function(e){hide_modal()}})}}),r=Backbone.View.extend({defaults:{nodeRadius:4.5},stdInit:function(e){var t=this;t.model.on("change:separation change:leafHeight change:fontSize change:nodeAttrChangedTime",t.updateAndRender,t),t.vis=e.vis,t.i=0,t.maxDepth=-1,t.width=e.width,t.height=e.height},updateAndRender:function(t){e.select(".vis");var n=this;t=t||n.model.root,n.renderNodes(t),n.renderLinks(t),n.addTooltips()},renderLinks:function(e){var t=this,n=(t.diagonal,t.duration,t.layoutMode,t.vis.selectAll("g.completeLink").data(t.tree.links(t.nodes),function(e){return e.target.id})),i=function(e){e.pos0=e.source.y0+" "+e.source.x0,e.pos1=e.source.y0+" "+e.target.x0,e.pos2=e.target.y0+" "+e.target.x0};n.enter().insert("svg:g","g.node").attr("class","completeLink").append("svg:path").attr("class","link").attr("d",function(e){return i(e),"M "+e.pos0+" L "+e.pos1}),n.transition().duration(500).select("path.link").attr("d",function(e){return i(e),"M "+e.pos0+" L "+e.pos1+" L "+e.pos2});n.exit().remove()},selectNode:function(t){var n=this;e.selectAll("g.node").classed("selectedHighlight",function(e){return t.id===e.id&&(t._selected?(delete t._selected,!1):(t._selected=!0,!0))}),n.model.set("selectedNode",t),$("#phyloVizSelectedNodeName").val(t.name),$("#phyloVizSelectedNodeDist").val(t.dist),$("#phyloVizSelectedNodeAnnotation").val(t.annotation||"")},addTooltips:function(){$(".tooltip").remove(),$(".node").attr("data-original-title",function(){var e=this.__data__,t=e.annotation||"None";return e?(e.name?e.name+"<br/>":"")+"Dist: "+e.dist+" <br/>Annotation1: "+t+(e.bootstrap?"<br/>Confidence level: "+Math.round(100*e.bootstrap):""):""}).tooltip({placement:"top",trigger:"hover"})}}).extend({initialize:function(e){var t=this;t.margins=e.margins,t.layoutMode="Linear",t.stdInit(e),t.layout(),t.updateAndRender(t.model.root)},layout:function(){var t=this;t.tree=(new o).layoutMode("Linear"),t.diagonal=e.svg.diagonal().projection(function(e){return[e.y,e.x]})},renderNodes:function(t){var n=this,i=n.model.get("fontSize")+"px";n.tree.separation(n.model.get("separation")).leafHeight(n.model.get("leafHeight"));var o=n.tree.separation(n.model.get("separation")).nodes(n.model.root),a=n.vis.selectAll("g.node").data(o,function(e){return e.name+e.id||(e.id=++n.i)});n.nodes=o,n.duration=500;var l=a.enter().append("svg:g").attr("class","node").on("dblclick",function(){e.event.stopPropagation()}).on("click",function(t){if(e.event.altKey)n.selectNode(t);else{if(t.children&&0===t.children.length)return;n.model.toggle(t),n.updateAndRender(t)}});"[object Array]"===toString.call(t)&&(t=t[0]),l.attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"}),l.append("svg:circle").attr("r",1e-6).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}),l.append("svg:text").attr("class","nodeLabel").attr("x",function(e){return e.children||e._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(e){return e.children||e._children?"end":"start"}).style("fill-opacity",1e-6);var r=a.transition().duration(500);r.attr("transform",function(e){return"translate("+e.y+","+e.x+")"}),r.select("circle").attr("r",n.defaults.nodeRadius).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}),r.select("text").style("fill-opacity",1).style("font-size",i).text(function(e){return e.name&&""!==e.name?e.name:e.bootstrap?Math.round(100*e.bootstrap):""});var s=a.exit().transition().duration(500).remove();s.select("circle").attr("r",1e-6),s.select("text").style("fill-opacity",1e-6),o.forEach(function(e){e.x0=e.x,e.y0=e.y})}}),s=Backbone.View.extend({className:"phyloviz",initialize:function(t){var n=this;n.MIN_SCALE=.05,n.MAX_SCALE=5,n.MAX_DISPLACEMENT=500,n.margins=[10,60,10,80],n.width=$("#PhyloViz").width(),n.height=$("#PhyloViz").height(),n.radius=n.width,n.data=t.data,$(window).resize(function(){n.width=$("#PhyloViz").width(),n.height=$("#PhyloViz").height(),n.render()}),n.phyloTree=new l(t.config),n.phyloTree.root=n.data,n.zoomFunc=e.behavior.zoom().scaleExtent([n.MIN_SCALE,n.MAX_SCALE]),n.zoomFunc.translate(n.phyloTree.get("translate")),n.zoomFunc.scale(n.phyloTree.get("scaleFactor")),n.navMenu=new c(n),n.settingsMenu=new d({phyloTree:n.phyloTree}),n.nodeSelectionView=new h({phyloTree:n.phyloTree}),n.search=new u,setTimeout(function(){n.zoomAndPan()},1e3)},render:function(){var t=this;$("#PhyloViz").empty(),t.mainSVG=e.select("#PhyloViz").append("svg:svg").attr("width",t.width).attr("height",t.height).attr("pointer-events","all").call(t.zoomFunc.on("zoom",function(){t.zoomAndPan()})),t.boundingRect=t.mainSVG.append("svg:rect").attr("class","boundingRect").attr("width",t.width).attr("height",t.height).attr("stroke","black").attr("fill","white"),t.vis=t.mainSVG.append("svg:g").attr("class","vis"),t.layoutOptions={model:t.phyloTree,width:t.width,height:t.height,vis:t.vis,margins:t.margins},$("#title").text("Phylogenetic Tree from "+t.phyloTree.get("title")+":");new r(t.layoutOptions)},zoomAndPan:function(t){var n,i;void 0!==t&&(n=t.zoom,i=t.translate);var o=this,a=o.zoomFunc.scale(),l=o.zoomFunc.translate(),r="",s="";switch(n){case"reset":a=1,l=[0,0];break;case"+":a*=1.1;break;case"-":a*=.9;break;default:"number"==typeof n?a=n:null!==e.event&&(a=e.event.scale)}if(!(a<o.MIN_SCALE||a>o.MAX_SCALE)){if(o.zoomFunc.scale(a),r="translate("+o.margins[3]+","+o.margins[0]+") scale("+a+")",null!==e.event)s="translate("+e.event.translate+")";else{if(void 0!==i){var c=i.split(",")[0],d=i.split(",")[1];isNaN(c)||isNaN(d)||(l=[l[0]+parseFloat(c),l[1]+parseFloat(d)])}o.zoomFunc.translate(l),s="translate("+l+")"}o.phyloTree.set("scaleFactor",a),o.phyloTree.set("translate",l),o.vis.attr("transform",s+r)}},reloadViz:function(){var e=this,t=$("#phylovizNexSelector :selected").val();$.getJSON(e.phyloTree.get("dataset").url(),{tree_index:t,data_type:"raw_data"},function(t){e.data=t.data,e.config=t,e.render()})}}),c=Backbone.View.extend({initialize:function(e){var t=this;t.phylovizView=e,$("#panelHeaderRightBtns").empty(),$("#phyloVizNavBtns").empty(),$("#phylovizNexSelector").off(),t.initNavBtns(),t.initRightHeaderBtns(),$("#phylovizNexSelector").off().on("change",function(){t.phylovizView.reloadViz()})},initRightHeaderBtns:function(){var e=this,t=i.create_icon_buttons_menu([{icon_class:"gear",title:"PhyloViz Settings",on_click:function(){$("#SettingsMenu").show(),e.settingsMenu.updateUI()}},{icon_class:"disk",title:"Save visualization",on_click:function(){var t=$("#phylovizNexSelector option:selected").text();t&&e.phylovizView.phyloTree.set("title",t),e.phylovizView.phyloTree.save()}},{icon_class:"chevron-expand",title:"Search / Edit Nodes",on_click:function(){$("#nodeSelectionView").show()}},{icon_class:"information",title:"Phyloviz Help",on_click:function(){window.open("https://galaxyproject.org/learn/visualization/phylogenetic-tree/")}}],{tooltip_config:{placement:"bottom"}});$("#panelHeaderRightBtns").append(t.$el)},initNavBtns:function(){var e=this,t=i.create_icon_buttons_menu([{icon_class:"zoom-in",title:"Zoom in",on_click:function(){e.phylovizView.zoomAndPan({zoom:"+"})}},{icon_class:"zoom-out",title:"Zoom out",on_click:function(){e.phylovizView.zoomAndPan({zoom:"-"})}},{icon_class:"arrow-circle",title:"Reset Zoom/Pan",on_click:function(){e.phylovizView.zoomAndPan({zoom:"reset"})}}],{tooltip_config:{placement:"bottom"}});$("#phyloVizNavBtns").append(t.$el)}}),d=a.extend({className:"Settings",initialize:function(e){var t=this;t.phyloTree=e.phyloTree,t.el=$("#SettingsMenu"),t.inputs={separation:$("#phyloVizTreeSeparation"),leafHeight:$("#phyloVizTreeLeafHeight"),fontSize:$("#phyloVizTreeFontSize")},$("#settingsCloseBtn").off().on("click",function(){t.el.hide()}),$("#phylovizResetSettingsBtn").off().on("click",function(){t.resetToDefaults()}),$("#phylovizApplySettingsBtn").off().on("click",function(){t.apply()})},apply:function(){var e=this;e.isAcceptableValue(e.inputs.separation,50,2500)&&e.isAcceptableValue(e.inputs.leafHeight,5,30)&&e.isAcceptableValue(e.inputs.fontSize,5,20)&&$.each(e.inputs,function(t,n){e.phyloTree.set(t,n.val())})},updateUI:function(){var e=this;$.each(e.inputs,function(t,n){n.val(e.phyloTree.get(t))})},resetToDefaults:function(){$(".tooltip").remove();var e=this;$.each(e.phyloTree.defaults,function(t,n){e.phyloTree.set(t,n)}),e.updateUI()},render:function(){}}),h=a.extend({className:"Settings",initialize:function(e){var t=this;t.el=$("#nodeSelectionView"),t.phyloTree=e.phyloTree,t.UI={enableEdit:$("#phylovizEditNodesCheck"),saveChanges:$("#phylovizNodeSaveChanges"),cancelChanges:$("#phylovizNodeCancelChanges"),name:$("#phyloVizSelectedNodeName"),dist:$("#phyloVizSelectedNodeDist"),annotation:$("#phyloVizSelectedNodeAnnotation")},t.valuesOfConcern={name:null,dist:null,annotation:null},$("#nodeSelCloseBtn").off().on("click",function(){t.el.hide()}),t.UI.saveChanges.off().on("click",function(){t.updateNodes()}),t.UI.cancelChanges.off().on("click",function(){t.cancelChanges()}),function(e){e.fn.enable=function(t){return e(this).each(function(){t?e(this).removeAttr("disabled"):e(this).attr("disabled","disabled")})}}(jQuery),t.UI.enableEdit.off().on("click",function(){t.toggleUI()})},toggleUI:function(){var e=this,t=e.UI.enableEdit.is(":checked");t||e.cancelChanges(),$.each(e.valuesOfConcern,function(n,i){e.UI[n].enable(t)}),t?(e.UI.saveChanges.show(),e.UI.cancelChanges.show()):(e.UI.saveChanges.hide(),e.UI.cancelChanges.hide())},cancelChanges:function(){var e=this,t=e.phyloTree.get("selectedNode");t&&$.each(e.valuesOfConcern,function(n,i){e.UI[n].val(t[n])})},updateNodes:function(){var e=this,t=e.phyloTree.get("selectedNode");if(t){if(!e.isAcceptableValue(e.UI.dist,0,1)||e.hasIllegalJsonCharacters(e.UI.name)||e.hasIllegalJsonCharacters(e.UI.annotation))return;$.each(e.valuesOfConcern,function(n,i){t[n]=e.UI[n].val()}),e.phyloTree.set("nodeAttrChangedTime",new Date)}else alert("No node selected")}}),u=a.extend({initialize:function(){var e=this;$("#phyloVizSearchBtn").on("click",function(){var t=$("#phyloVizSearchTerm"),n=$("#phyloVizSearchCondition").val().split("-"),i=n[0],o=n[1];e.hasIllegalJsonCharacters(t),"dist"===i&&e.isAcceptableValue(t,0,1),e.searchTree(i,o,t.val())})},searchTree:function(t,n,i){e.selectAll("g.node").classed("searchHighlight",function(e){var o=e[t];if(void 0!==o&&null!==o)if("dist"===t)switch(n){case"greaterEqual":return o>=+i;case"lesserEqual":return o<=+i;default:return}else if("name"===t||"annotation"===t)return-1!==o.toLowerCase().indexOf(i.toLowerCase())})}});return{PhylovizView:s}});
//# sourceMappingURL=../../maps/viz/phyloviz.js.map
