{"version":3,"sources":["mvc/ui/error-modal.js"],"names":["define","_l","_errorModal","message","title","details","Galaxy","modal","show","body","Ok","hide","$el","addClass","$","errorModal","alert","log","appendTo","offlineErrorModal","toggle","CONTACT_MSG","_ajaxDetails","options","console","JSON","stringify","model","xhr","raven","_","result","window","Raven","userAgent","navigator","onLine","version","config","omit","functions","url","lastAjax","data","user","DEFAULT_AJAX_ERR_MSG","closing_events","badGatewayErrorModal","ajaxErrorModal"],"mappings":"aAAAA,QAAQ,sBAAuB,SAASC,GAiDvB,SAAAC,EAAAC,EAAAC,EAAAC,GA2Db,OAlEsBC,OAAlBC,MAAAC,MAUAF,MAAOC,EARHE,KAAMN,EAUNE,gBAAS,EACTC,SAIEI,GAAA,WAXMJ,OAAOC,MAAMI,WA6BxBL,OAAAC,MAAAK,IAAAC,SAAA,eAEJR,IAxBOC,OAAOC,MA0BfO,EAAA,kBACSC,IAAAA,OAAWZ,MAASC,EAAAA,+BACpBD,SACDW,EAAA,UACHD,SAAA,iBAxBQF,OA0BTR,SAAaA,OAAbI,MAAAO,EAAA,mBACQb,QACGK,EAAAA,QAAUA,KAAAA,GACVJ,EAAAA,UAAYC,KAAAA,KAASC,UAAOC,EAAnC,KAAA,SAGJW,EACQC,2CACXhB,EAAA,WAxBe,aA2BhBiB,SAAAZ,OAAAC,MAAAO,EAAA,aACSK,MAAAA,WACEJ,OACHd,MACIa,EAAA,kBAAAM,YAMZd,OAAAC,MAWC,SAAAQ,EAAAZ,EAAAC,EAAAC,GApCG,GAAKF,EAAL,CA2CAC,GAFAD,EAAUA,EAAAA,GACVA,EAAAA,EAAWC,IAAMiB,EAAAA,UACjBjB,OAAQA,QAAYE,OAAAC,MAChBF,OAAAA,EAAUiB,EAAAlB,EAAyBmB,GAlCvCP,MAAMZ,EAAQ,OAASD,GAsC3BqB,QAAAP,IAAA,iBAAAQ,KAAAC,UAAArB,KACA,SAASiB,EAAaK,EAAOC,EAAKL,GAC9B,OAEIM,MAAOC,EAAEC,OAAOC,OAAOC,MAAO,eAC9BC,UAAWC,UAAUD,UACrBE,OAAQD,UAAUC,OAClBC,QAASP,EAAEC,OAAOzB,OAAOgC,OAAQ,iBACjCV,IAAKE,EAAES,KAAKX,EAAKE,EAAEU,UAAUZ,IAC7BL,QAASO,EAAES,KAAKhB,EAAS,OAEzBkB,IAAKX,EAAEC,OAAOzB,OAAOoC,SAAU,OAC/BC,KAAMb,EAAEC,OAAOzB,OAAOoC,SAAU,QAEhCf,MAAOG,EAAEC,OAAOJ,EAAO,SAAUA,EAAQ,IACzCiB,KAAMd,EAAES,KAAKT,EAAEC,OAAOzB,OAAOsC,KAAM,UAAW,UArHtD,IAAIvB,EAAcpB,EAUlB,kEAEI4C,EAAA5C,EACAK,iEAEIG,EAAMN,EACN2C,2FA0GR,OACI/B,WAAYA,EACZI,kBAjBIe,WACAE,OAAAA,EACAC,EACAT,yEAEA3B,EAAA,cAaJ8C,qBArBO,WAeV,OAAAhC,EApCOd,EAsCR,uEAEIc,IACAI,EACA4B,EAAAA,8BACAC,eAhCJ,SAAwBrB,EAAOC,EAAKL,EAASpB,EAASC,GAKlD,OAJAD,EAAUA,GAAW0C,EAId9B,EAHPZ,GAAW,IAAMkB,EACjBjB,EAAQA,GAASH,EAAG,qBACNqB,EAAaK,EAAOC,EAAKL","file":"../../../scripts/mvc/ui/error-modal.js","sourcesContent":["define([\"utils/localization\"], function(_l) {\n    \"use strict\";\n\n    //TODO: toastr is another possibility - I didn't see where I might add details, tho\n\n    /* ============================================================================\nError modals meant to replace the o-so-easy alerts.\n\nThese are currently styled as errormessages but use the Galaxy.modal\ninfrastructure to be shown/closed. They're capable of showing details in a\ntogglable dropdown and the details are formatted in a pre.\n\nExample:\n    errorModal( 'Heres a message', 'A Title', { some_details: 'here' });\n    errorModal( 'Heres a message' ); // no details, title is 'Error'\n\nThere are three specialized forms:\n    offlineErrorModal       a canned response for when there's no connection\n    badGatewayErrorModal    canned response for when Galaxy is restarting\n    ajaxErrorModal          plugable into any Backbone class as an\n        error event handler by accepting the error args: model, xhr, options\n\nExamples:\n    if( navigator.offLine ){ offlineErrorModal(); }\n    if( xhr.status === 502 ){ badGatewayErrorModal(); }\n    this.listenTo( this.model, 'error', ajaxErrorModal );\n\n============================================================================ */\n\n    var CONTACT_MSG = _l(\n        \"Please contact a Galaxy administrator if the problem persists.\"\n    );\n    var DEFAULT_AJAX_ERR_MSG = _l(\n        \"An error occurred while updating information with the server.\"\n    );\n    var DETAILS_MSG = _l(\n        \"The following information can assist the developers in finding the source of the error:\"\n    );\n\n    /** private helper that builds the modal and handles adding details */\n    function _errorModal(message, title, details) {\n        // create and return the modal, adding details button only if needed\n        Galaxy.modal.show({\n            title: title,\n            body: message,\n            closing_events: true,\n            buttons: {\n                Ok: function() {\n                    Galaxy.modal.hide();\n                }\n            }\n        });\n        Galaxy.modal.$el.addClass(\"error-modal\");\n\n        if (details) {\n            Galaxy.modal\n                .$(\".error-details\")\n                .add(Galaxy.modal.$('button:contains(\"Details\")'))\n                .remove();\n            $(\"<div/>\")\n                .addClass(\"error-details\")\n                .hide()\n                .appendTo(Galaxy.modal.$(\".modal-content\"))\n                .append([\n                    $(\"<p/>\").text(DETAILS_MSG),\n                    $(\"<pre/>\").text(JSON.stringify(details, null, \"  \"))\n                ]);\n\n            $(\n                '<button id=\"button-1\" class=\"pull-left\">' +\n                    _l(\"Details\") +\n                    \"</button>\"\n            )\n                .appendTo(Galaxy.modal.$(\".buttons\"))\n                .click(function() {\n                    Galaxy.modal.$(\".error-details\").toggle();\n                });\n        }\n        return Galaxy.modal;\n    }\n\n    /** Display a modal showing an error message but fallback to alert if there's no modal */\n    function errorModal(message, title, details) {\n        if (!message) {\n            return;\n        }\n\n        message = _l(message);\n        title = _l(title) || _l(\"Error:\");\n        if (window.Galaxy && Galaxy.modal) {\n            return _errorModal(message, title, details);\n        }\n\n        alert(title + \"\\n\\n\" + message);\n        console.log(\"error details:\", JSON.stringify(details));\n    }\n\n    // ----------------------------------------------------------------------------\n    /** display a modal when the user may be offline */\n    function offlineErrorModal() {\n        return errorModal(\n            _l(\n                \"You appear to be offline. Please check your connection and try again.\"\n            ),\n            _l(\"Offline?\")\n        );\n    }\n\n    // ----------------------------------------------------------------------------\n    /** 502 messages that should be displayed when galaxy is restarting */\n    function badGatewayErrorModal() {\n        return errorModal(\n            _l(\n                \"Galaxy is currently unreachable. Please try again in a few minutes.\"\n            ) +\n                \" \" +\n                CONTACT_MSG,\n            _l(\"Cannot connect to Galaxy\")\n        );\n    }\n\n    // ----------------------------------------------------------------------------\n    /** display a modal (with details) about a failed Backbone ajax operation */\n    function ajaxErrorModal(model, xhr, options, message, title) {\n        message = message || DEFAULT_AJAX_ERR_MSG;\n        message += \" \" + CONTACT_MSG;\n        title = title || _l(\"An error occurred\");\n        var details = _ajaxDetails(model, xhr, options);\n        return errorModal(message, title, details);\n    }\n\n    /** build details which may help debugging the ajax call */\n    function _ajaxDetails(model, xhr, options) {\n        return {\n            //TODO: still can't manage Raven id\n            raven: _.result(window.Raven, \"lastEventId\"),\n            userAgent: navigator.userAgent,\n            onLine: navigator.onLine,\n            version: _.result(Galaxy.config, \"version_major\"),\n            xhr: _.omit(xhr, _.functions(xhr)),\n            options: _.omit(options, \"xhr\"),\n            // add ajax data from Galaxy object cache\n            url: _.result(Galaxy.lastAjax, \"url\"),\n            data: _.result(Galaxy.lastAjax, \"data\"),\n            // backbone stuff (auto-redacting email for user)\n            model: _.result(model, \"toJSON\", model + \"\"),\n            user: _.omit(_.result(Galaxy.user, \"toJSON\"), \"email\")\n        };\n    }\n\n    //=============================================================================\n    return {\n        errorModal: errorModal,\n        offlineErrorModal: offlineErrorModal,\n        badGatewayErrorModal: badGatewayErrorModal,\n        ajaxErrorModal: ajaxErrorModal\n    };\n});\n"]}