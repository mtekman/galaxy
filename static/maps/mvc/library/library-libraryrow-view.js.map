{"version":3,"sources":["mvc/library/library-libraryrow-view.js"],"names":["define","mod_masthead","mod_toastr","LibraryRowView","Backbone","View","extend","events","click .edit_library_btn","click .cancel_library_btn","click .save_library_btn","click .delete_library_btn","click .undelete_library_btn","element_visibility_config","edit_library_btn","permission_library_btn","save_library_btn","cancel_library_btn","delete_library_btn","undelete_library_btn","initialize","library","this","render","prepareButtons","libraryListView","collection","get","tmpl","$el","templateRow","button_config","edit_mode","$","setElement","show","repaint","old_element","hide","replaceWith","find","tooltip","vis_config","upload_library_btn","cancel_library_modification","save_library_modification","is_changed","libraries","new_name","val","new_description","length","new_synopsis","warning","patch","row_view","set","error","save","delete_library","Galaxy","destroy","success","model","response","responseJSON","err_msg","info","data","undelete_library","add","url","preferences","urlRoot","id","_","template","join"],"mappings":"aACAA,QAAQ,kBAAmB,cAAe,eAAgB,SAD1DC,EACAD,EAKIE,GAkTA,OACIC,eAhTIC,SAAAC,KAA2BC,QAC3BC,QACAC,0BAA2B,sBAC3BC,4BAA6B,8BAC7BC,0BAAA,4BANkCC,4BAAA,iBAMlCC,8BAA+B,oBAKnCC,WAAAA,EAEIC,2BACAC,oBAAAA,EACAC,kBAAkB,EAClBC,wBAAoB,EACpBC,kBAAAA,EACAC,oBAAAA,EAlBkCD,oBAAA,EAkBlCC,sBAAsB,GAKzBC,WAvBqC,SAAAC,GAsBlCC,KAAKC,OAAOF,IAKRA,OAAAA,SAAAA,QAGH,IAAAA,IACDA,EAAKG,OAAeH,UAApBI,gBAAAC,WAAAC,IACIC,KAAOC,IAAKC,KAAAA,QAIRC,KAAAA,eAAeV,GACfW,IAAAA,EAAAA,KAAWF,cAUnBG,OAbSX,KADTY,WAOAN,GACOP,QAAPA,EAzCkCU,cAAAT,KAAAT,0BAqC1BmB,UAAWV,KAAKU,aAGxBV,KAAKO,IAAIM,OAOPb,MAGFc,QAAIC,SAAAA,GAGJJ,EAAA,YAAAK,OAGA,IAAAD,EAAcf,KAAAO,IAGlBP,KAAAC,SALIc,EAAYE,YAAYjB,KAAKO,KAE7BP,KAAKO,IAAIW,KAAK,iBAAiBC,WAa3BC,eAAAA,SAAWxB,GACX,IAAAwB,EAAYf,KAAId,2BAED8B,IAAXD,KAAAA,WACAA,EAAAA,kBAAW5B,EACX4B,EAAAA,oBAAW3B,EACd2B,EAAUrB,oBAAA,GACP,IAAAqB,EAAAA,IAAW1B,YACX0B,EAAWzB,sBAAqB,EAChCyB,EAAWvB,oBAAX,EACAuB,EAAIrB,kBAAA,EACAqB,EAAAA,wBAAgC,IACnC,IAAArB,EAAAM,IAAA,aACDe,EAAIrB,kBAAY,EACZqB,EAAAA,oBAAA,EACHA,EAAAvB,sBAAA,GACG,IAAAE,EAAQM,IAAI,kBACZe,EAAW3B,oBAAAA,IAElB,IAAAM,EAAAM,IAAA,qBACMe,EAAKV,kBAAoB,IAEhC,IAAAU,EAAW5B,IAAAA,qBACX4B,EAAW3B,wBAAX,MAGWG,IAAXwB,KAAWxB,YACXwB,EAAWvB,oBAAX,EACHuB,EAAA5B,kBAAA,EALG4B,EAAW3B,wBAAyB,EAOxC2B,EAAK7B,kBAA4B6B,EAnGCA,EAAAzB,oBAAA,EA+F9ByB,EAAWxB,oBAAqB,EAOxCwB,EAAAvB,sBAAA,GAGIG,KAAKU,0BAALU,GAKJE,oBAAAA,WACItB,KAAAU,WAAA,EACAV,KAAKU,WAITa,4BAA2B,WAIvBvB,KAAIwB,WAAa,EAPjBxB,KAAKc,WAcDS,0BAAI,WACAxB,IAAAA,EAAAA,OAAY0B,UAAQC,gBAApBtB,WAAAC,IACAmB,KAAAA,IAAAA,KAAAA,OAEA5C,GAAAA,EAIH8C,EAAA1B,KAAAO,IAAAW,KAAA,uBAAAS,MACJ,QAZuB,IAAbD,GAcPE,IAAAA,EAAkBvB,IAAKE,QAG3B,CAIIR,KAAAA,EAAY8B,OAAA,GAUZL,YANAM,EAAeC,QAERD,sDALPN,EAAAA,IAAa,OAAbE,GACHF,GAAA,EAYG,IAAAI,EAAe5B,KAAfO,IACAR,KAAAA,8BACIiC,WAEI,IAAAC,GACAA,IAASnB,EAAQf,IAAjB,iBAEHA,EANcmC,IAAA,cAAAN,GAOfO,GAAO,GAGF,IAAAL,EAAM9B,KAAAO,IAAAW,KAAA,2BAAAS,MAWlB,QAPY,IAAAG,GACJA,IAAA/B,EAAAM,IAAA,cAjBTN,EAmBOmC,IAAA,WAAAJ,GACHN,GAAKd,GAGRc,EAAA,CArLiC,IAAAS,EAAAjC,KAgK9BD,EAAQqC,KAAK,MAwBrBC,OAAgB,EACRtC,QAAUuC,SAAOb,GAGjBQ,EAAJvB,WAAA,EACAuB,EAAAnB,QAAAf,GACQwC,EAAQC,QAAA,8BAERzC,MAAAA,SAAY0C,EAAWC,QACvB,IAAAA,EAAAC,aACOlB,EAAUtB,MAAAA,EAAgBC,aAAjCwC,SAGIN,EAAOb,MAGL,oEASN7C,KAAAA,WAAW4D,EACdxC,KApBWc,QAAAf,GAqBZoC,EAAOU,KAAA,yBAICjE,eAAAA,WAGH,IA1NyBqD,EAAAjC,KA0NzBsC,OAAAb,UAAAtB,gBAAAC,WAAAC,IACJL,KAAAO,IAAAuC,KAAA,OAITC,SACQhD,QAAAA,SAAiB0B,GAGjBQ,EAAWC,IAAf,WAAA,GAEAI,OAAAb,UAAAtB,gBAAAC,WAAA4C,IAAAjD,GACQkD,EAAMlD,WAAA,GAGN,IADJyC,OAASf,UAAAyB,YAAkB7C,IAAA,iBAGvBN,EAAAA,YAAYiB,OACZsB,EAAOb,QAAUtB,GACjB8B,EAASvB,IAAAA,WAND,IAQR9B,OAAW4D,UAAQU,YAAA7C,IAAA,iBAGf4B,EAAOS,QAASC,GAEnB/D,EAAM4D,QAAA,qCAINL,MAAA,SAAAM,EAAAC,QACJ,IAAAA,EAAAC,aAlBL/D,EAAAuD,MAAAO,EAAAC,aAAAC,SAhBYhE,EAAWuD,MAsCd,qDAoDjBY,iBAAO,WACHlE,IAAAA,EAAgBA,OAAAA,UAAAA,gBAAAA,WAAAA,IADpBmB,KAAAO,IAAAuC,KAAA,OA9EYb,EAAWjC,KAGfD,EAAQkD,IAAMlD,EAAQoD,QAAUpD,EAAQqD,GAAK,iBAC7CrD,EAAQwC,SACJC,QAAS,SAASzC,GAGdA,EAAQmC,IAAI,WAAW,GACvBI,OAAOb,UAAUtB,gBAAgBC,WAAW4C,IAAIjD,GAChDkC,EAASvB,WAAY,EACrBuB,EAASnB,QAAQf,GACjBnB,EAAW4D,QAAQ,gCAEvBL,MAAO,SAASM,EAAOC,QACkB,IAA1BA,EAASC,aAChB/D,EAAWuD,MAAMO,EAASC,aAAaC,SAEvChE,EAAWuD,MACP,sDAOpB3B,YAAa,WACT,OAAO6C,EAAEC,UAED,sIACA,yBACA,qCACA,0DACA,iBACA,kGACA,UACA,yCACA,wDACA,kLACA,iBACA,sDACA,UACA,iBACA,YACA,UACA,sCACA,sDACA,6KACA,iBACA,mDACA,UACA,iBACA,YACA,UACA,8BACA,gIACA,qJACA,4IACA,UACA,4BACA,8EACA,uIACA,SACA,uSACA,wXACA,gRACA,sRACA,8SAEA,gNACA,sTACA,QACA,SACFC,KAAK","file":"../../../scripts/mvc/library/library-libraryrow-view.js","sourcesContent":["// dependencies\ndefine([\"layout/masthead\", \"utils/utils\", \"libs/toastr\"], function(\n    mod_masthead,\n    mod_utils,\n    mod_toastr\n) {\n    // galaxy library row view\n    var LibraryRowView = Backbone.View.extend({\n        events: {\n            \"click .edit_library_btn\": \"edit_button_clicked\",\n            \"click .cancel_library_btn\": \"cancel_library_modification\",\n            \"click .save_library_btn\": \"save_library_modification\",\n            \"click .delete_library_btn\": \"delete_library\",\n            \"click .undelete_library_btn\": \"undelete_library\"\n        },\n\n        edit_mode: false,\n\n        element_visibility_config: {\n            upload_library_btn: false,\n            edit_library_btn: false,\n            permission_library_btn: false,\n            save_library_btn: false,\n            cancel_library_btn: false,\n            delete_library_btn: false,\n            undelete_library_btn: false\n        },\n\n        initialize: function(library) {\n            this.render(library);\n        },\n\n        render: function(library) {\n            if (typeof library === \"undefined\") {\n                library = Galaxy.libraries.libraryListView.collection.get(\n                    this.$el.data(\"id\")\n                );\n            }\n            this.prepareButtons(library);\n            var tmpl = this.templateRow();\n            this.setElement(\n                tmpl({\n                    library: library,\n                    button_config: this.element_visibility_config,\n                    edit_mode: this.edit_mode\n                })\n            );\n            this.$el.show();\n            return this;\n        },\n\n        repaint: function(library) {\n            /* need to hide manually because of the element removal in setElement\n    invoked in render() */\n            $(\".tooltip\").hide();\n            /* we need to store the old element to be able to replace it with\n    new one */\n            var old_element = this.$el;\n            /* if user canceled the library param is undefined,\n      if user saved and succeeded the updated library is rendered */\n            this.render();\n            old_element.replaceWith(this.$el);\n            /* now we attach new tooltips to the newly created row element */\n            this.$el.find(\"[data-toggle]\").tooltip();\n        },\n\n        /**\n   * Function modifies the visibility of buttons for\n   * the filling of the row template of given library.\n   */\n        prepareButtons: function(library) {\n            var vis_config = this.element_visibility_config;\n\n            if (this.edit_mode === false) {\n                vis_config.save_library_btn = false;\n                vis_config.cancel_library_btn = false;\n                vis_config.delete_library_btn = false;\n                if (library.get(\"deleted\") === true) {\n                    vis_config.undelete_library_btn = true;\n                    vis_config.upload_library_btn = false;\n                    vis_config.edit_library_btn = false;\n                    vis_config.permission_library_btn = false;\n                } else if (library.get(\"deleted\") === false) {\n                    vis_config.save_library_btn = false;\n                    vis_config.cancel_library_btn = false;\n                    vis_config.undelete_library_btn = false;\n                    if (library.get(\"can_user_add\") === true) {\n                        vis_config.upload_library_btn = true;\n                    }\n                    if (library.get(\"can_user_modify\") === true) {\n                        vis_config.edit_library_btn = true;\n                    }\n                    if (library.get(\"can_user_manage\") === true) {\n                        vis_config.permission_library_btn = true;\n                    }\n                }\n            } else if (this.edit_mode === true) {\n                vis_config.upload_library_btn = false;\n                vis_config.edit_library_btn = false;\n                vis_config.permission_library_btn = false;\n                vis_config.save_library_btn = true;\n                vis_config.cancel_library_btn = true;\n                vis_config.delete_library_btn = true;\n                vis_config.undelete_library_btn = false;\n            }\n\n            this.element_visibility_config = vis_config;\n        },\n\n        /* User clicked the 'edit' button on row so we render a new row\n    that allows editing */\n        edit_button_clicked: function() {\n            this.edit_mode = true;\n            this.repaint();\n        },\n\n        /* User clicked the 'cancel' button so we render normal rowView */\n        cancel_library_modification: function() {\n            // mod_toastr.info('Modifications canceled');\n            this.edit_mode = false;\n            this.repaint();\n        },\n\n        save_library_modification: function() {\n            var library = Galaxy.libraries.libraryListView.collection.get(\n                this.$el.data(\"id\")\n            );\n            var is_changed = false;\n\n            var new_name = this.$el.find(\".input_library_name\").val();\n            if (\n                typeof new_name !== \"undefined\" &&\n                new_name !== library.get(\"name\")\n            ) {\n                if (new_name.length > 2) {\n                    library.set(\"name\", new_name);\n                    is_changed = true;\n                } else {\n                    mod_toastr.warning(\n                        \"Library name has to be at least 3 characters long.\"\n                    );\n                    return;\n                }\n            }\n\n            var new_description = this.$el\n                .find(\".input_library_description\")\n                .val();\n            if (\n                typeof new_description !== \"undefined\" &&\n                new_description !== library.get(\"description\")\n            ) {\n                library.set(\"description\", new_description);\n                is_changed = true;\n            }\n\n            var new_synopsis = this.$el.find(\".input_library_synopsis\").val();\n            if (\n                typeof new_synopsis !== \"undefined\" &&\n                new_synopsis !== library.get(\"synopsis\")\n            ) {\n                library.set(\"synopsis\", new_synopsis);\n                is_changed = true;\n            }\n\n            if (is_changed) {\n                var row_view = this;\n                library.save(null, {\n                    patch: true,\n                    success: function(library) {\n                        row_view.edit_mode = false;\n                        row_view.repaint(library);\n                        mod_toastr.success(\"Changes to library saved.\");\n                    },\n                    error: function(model, response) {\n                        if (typeof response.responseJSON !== \"undefined\") {\n                            mod_toastr.error(response.responseJSON.err_msg);\n                        } else {\n                            mod_toastr.error(\n                                \"An error occured while attempting to update the library.\"\n                            );\n                        }\n                    }\n                });\n            } else {\n                this.edit_mode = false;\n                this.repaint(library);\n                mod_toastr.info(\"Nothing has changed.\");\n            }\n        },\n\n        delete_library: function() {\n            var library = Galaxy.libraries.libraryListView.collection.get(\n                this.$el.data(\"id\")\n            );\n            var row_view = this;\n            // mark the library deleted\n            library.destroy({\n                success: function(library) {\n                    library.set(\"deleted\", true);\n                    // add the new deleted library back to the collection (Galaxy specialty)\n                    Galaxy.libraries.libraryListView.collection.add(library);\n                    row_view.edit_mode = false;\n                    if (\n                        Galaxy.libraries.preferences.get(\"with_deleted\") ===\n                        false\n                    ) {\n                        $(\".tooltip\").hide();\n                        row_view.repaint(library);\n                        row_view.$el.remove();\n                    } else if (\n                        Galaxy.libraries.preferences.get(\"with_deleted\") ===\n                        true\n                    ) {\n                        row_view.repaint(library);\n                    }\n                    mod_toastr.success(\"Library has been marked deleted.\");\n                },\n                error: function(model, response) {\n                    if (typeof response.responseJSON !== \"undefined\") {\n                        mod_toastr.error(response.responseJSON.err_msg);\n                    } else {\n                        mod_toastr.error(\n                            \"An error occured during deleting the library.\"\n                        );\n                    }\n                }\n            });\n        },\n\n        undelete_library: function() {\n            var library = Galaxy.libraries.libraryListView.collection.get(\n                this.$el.data(\"id\")\n            );\n            var row_view = this;\n\n            // mark the library undeleted\n            library.url = library.urlRoot + library.id + \"?undelete=true\";\n            library.destroy({\n                success: function(library) {\n                    // add the newly undeleted library back to the collection\n                    // backbone does not accept changes through destroy, so update it too\n                    library.set(\"deleted\", false);\n                    Galaxy.libraries.libraryListView.collection.add(library);\n                    row_view.edit_mode = false;\n                    row_view.repaint(library);\n                    mod_toastr.success(\"Library has been undeleted.\");\n                },\n                error: function(model, response) {\n                    if (typeof response.responseJSON !== \"undefined\") {\n                        mod_toastr.error(response.responseJSON.err_msg);\n                    } else {\n                        mod_toastr.error(\n                            \"An error occured while undeleting the library.\"\n                        );\n                    }\n                }\n            });\n        },\n\n        templateRow: function() {\n            return _.template(\n                [\n                    '<tr class=\"<% if(library.get(\"deleted\") === true) { print(\"active\") } %>\" style=\"display:none;\" data-id=\"<%- library.get(\"id\") %>\">',\n                    \"<% if(!edit_mode) { %>\",\n                    '<% if(library.get(\"deleted\")) { %>',\n                    '<td style=\"color:grey;\"><%- library.get(\"name\") %></td>',\n                    \"<% } else { %>\",\n                    '<td><a href=\"#folders/<%- library.get(\"root_folder_id\") %>\"><%- library.get(\"name\") %></a></td>',\n                    \"<% } %>\",\n                    '<% if(library.get(\"description\")) { %>',\n                    '<% if( (library.get(\"description\")).length> 80 ) { %>',\n                    '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"description\")) %>\"><%= _.escape(library.get(\"description\")).substring(0, 80) + \"...\" %></td>',\n                    \"<% } else { %>\",\n                    '<td><%= _.escape(library.get(\"description\"))%></td>',\n                    \"<% } %>\",\n                    \"<% } else { %>\",\n                    \"<td></td>\",\n                    \"<% } %>\",\n                    '<% if(library.get(\"synopsis\")) { %>',\n                    '<% if( (library.get(\"synopsis\")).length> 120 ) { %>',\n                    '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"synopsis\")) %>\"><%= _.escape(library.get(\"synopsis\")).substring(0, 120) + \"...\" %></td>',\n                    \"<% } else { %>\",\n                    '<td><%= _.escape(library.get(\"synopsis\"))%></td>',\n                    \"<% } %>\",\n                    \"<% } else { %>\",\n                    \"<td></td>\",\n                    \"<% } %>\",\n                    \"<% } else if(edit_mode){ %>\",\n                    '<td><textarea rows=\"4\" class=\"form-control input_library_name\" placeholder=\"name\" ><%- library.get(\"name\") %></textarea></td>',\n                    '<td><textarea rows=\"4\" class=\"form-control input_library_description\" placeholder=\"description\" ><%- library.get(\"description\") %></textarea></td>',\n                    '<td><textarea rows=\"4\" class=\"form-control input_library_synopsis\" placeholder=\"synopsis\" ><%- library.get(\"synopsis\") %></textarea></td>',\n                    \"<% } %>\",\n                    '<td class=\"right-center\">',\n                    '<% if( (library.get(\"public\")) && (library.get(\"deleted\") === false) ) { %>',\n                    '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Unrestricted library\" style=\"color:grey;\" class=\"fa fa-globe fa-lg\"> </span>',\n                    \"<% }%>\",\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Modify \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs edit_library_btn\" type=\"button\" style=\"<% if(button_config.edit_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-pencil\"></span> Edit</button>',\n                    '<a href=\"#library/<%- library.get(\"id\") %>/permissions\"><button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Permissions of \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs permission_library_btn\" type=\"button\" style=\"<% if(button_config.permission_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-group\"></span> Manage</button></a>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Save changes\" class=\"primary-button btn-xs save_library_btn\" type=\"button\" style=\"<% if(button_config.save_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-floppy-o\"></span> Save</button>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Discard changes\" class=\"primary-button btn-xs cancel_library_btn\" type=\"button\" style=\"<% if(button_config.cancel_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-times\"></span> Cancel</button>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Delete \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs delete_library_btn\" type=\"button\" style=\"<% if(button_config.delete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-trash-o\"></span> Delete</button>',\n                    // For deleted libraries\n                    '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Marked deleted\" style=\"color:grey; <% if(button_config.undelete_library_btn === false) { print(\"display:none;\") } %>\" class=\"fa fa-ban fa-lg\"></span>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Undelete \\'<%- library.get(\"name\") %>\\' \" class=\"primary-button btn-xs undelete_library_btn\" type=\"button\" style=\"<% if(button_config.undelete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-unlock\"></span> Undelete</button>',\n                    \"</td>\",\n                    \"</tr>\"\n                ].join(\"\")\n            );\n        }\n    });\n\n    return {\n        LibraryRowView: LibraryRowView\n    };\n});\n"]}