{"version":3,"sources":["mvc/upload/composite/composite-view.js"],"names":["define","collection","initialize","Utils","UploadModel","UploadRow","UploadExtension","Popover","title","onclick","Backbone","View","extend","Collection","btnClose","Ui","this","app","self","modal","hide","list_extensions","list_genomes","ftp_upload_site","currentFtp","setElement","_template","btnStart","Button","select_extension","data","ext","onchange","_","each","details","composite_files","button","$el","Select","css","container","$","filter","extension","reset","findWhere","e","target","item","add","id","size","file_desc","description","name","value","options","default_genome","text","model","_eventAnnounce","placement","on","select_genome","get","disable","listenTo","status","addClass","render","removeClass","first","enable","where","length","_eventStart","uploadpost","url","nginx_upload_path","_eventProgress","upload_row","append","_eventSuccess","set","toData","_eventError","message","it","error","progress","percentage","Galaxy","currHistoryPanel","refreshContents","info"],"mappings":"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","file":"../../../../scripts/mvc/upload/composite/composite-view.js","sourcesContent":["/** Renders contents of the composite uploader */\ndefine(\n    [\n        \"utils/utils\",\n        \"mvc/upload/upload-model\",\n        \"mvc/upload/composite/composite-row\",\n        \"mvc/upload/upload-extension\",\n        \"mvc/ui/ui-popover\",\n        \"mvc/ui/ui-select\",\n        \"mvc/ui/ui-misc\"\n    ],\n    function(\n        Utils,\n        UploadModel,\n        UploadRow,\n        UploadExtension,\n        Popover,\n        Select,\n        Ui\n    ) {\n        return Backbone.View.extend({\n            collection: new UploadModel.Collection(),\n            initialize: function(app) {\n                var self = this;\n                this.app = app;\n                this.options = app.options;\n                this.list_extensions = app.list_extensions;\n                this.list_genomes = app.list_genomes;\n                this.ftp_upload_site = app.currentFtp();\n                this.setElement(this._template());\n\n                // create button section\n                this.btnStart = new Ui.Button({\n                    title: \"Start\",\n                    onclick: function() {\n                        self._eventStart();\n                    }\n                });\n                this.btnClose = new Ui.Button({\n                    title: \"Close\",\n                    onclick: function() {\n                        self.app.modal.hide();\n                    }\n                });\n\n                // append buttons to dom\n                _.each([this.btnStart, this.btnClose], function(button) {\n                    self.$(\".upload-buttons\").prepend(button.$el);\n                });\n\n                // select extension\n                this.select_extension = new Select.View({\n                    css: \"upload-footer-selection\",\n                    container: this.$(\".upload-footer-extension\"),\n                    data: _.filter(this.list_extensions, function(ext) {\n                        return ext.composite_files;\n                    }),\n                    onchange: function(extension) {\n                        self.collection.reset();\n                        var details = _.findWhere(self.list_extensions, {\n                            id: extension\n                        });\n                        if (details && details.composite_files) {\n                            _.each(details.composite_files, function(item) {\n                                self.collection.add({\n                                    id: self.collection.size(),\n                                    file_desc: item.description || item.name\n                                });\n                            });\n                        }\n                    }\n                });\n\n                // handle extension info popover\n                this.$(\".upload-footer-extension-info\")\n                    .on(\"click\", function(e) {\n                        new UploadExtension({\n                            $el: $(e.target),\n                            title: self.select_extension.text(),\n                            extension: self.select_extension.value(),\n                            list: self.list_extensions,\n                            placement: \"top\"\n                        });\n                    })\n                    .on(\"mousedown\", function(e) {\n                        e.preventDefault();\n                    });\n\n                // genome extension\n                this.select_genome = new Select.View({\n                    css: \"upload-footer-selection\",\n                    container: this.$(\".upload-footer-genome\"),\n                    data: this.list_genomes,\n                    value: this.options.default_genome\n                });\n\n                // listener for collection triggers on change in composite datatype and extension selection\n                this.listenTo(this.collection, \"add\", function(model) {\n                    self._eventAnnounce(model);\n                });\n                this.listenTo(this.collection, \"change add\", function() {\n                    self.render();\n                });\n                this.select_extension.options.onchange(\n                    this.select_extension.value()\n                );\n                this.render();\n            },\n\n            render: function() {\n                var model = this.collection.first();\n                if (model && model.get(\"status\") == \"running\") {\n                    this.select_genome.disable();\n                    this.select_extension.disable();\n                } else {\n                    this.select_genome.enable();\n                    this.select_extension.enable();\n                }\n                if (\n                    this.collection.where({ status: \"ready\" }).length ==\n                        this.collection.length &&\n                    this.collection.length > 0\n                ) {\n                    this.btnStart.enable();\n                    this.btnStart.$el.addClass(\"btn-primary\");\n                } else {\n                    this.btnStart.disable();\n                    this.btnStart.$el.removeClass(\"btn-primary\");\n                }\n                this.$(\".upload-table\")[\n                    this.collection.length > 0 ? \"show\" : \"hide\"\n                ]();\n            },\n\n            //\n            // upload events / process pipeline\n            //\n\n            /** Builds the basic ui with placeholder rows for each composite data type file */\n            _eventAnnounce: function(model) {\n                var upload_row = new UploadRow(this, { model: model });\n                this.$(\".upload-table > tbody:first\").append(upload_row.$el);\n                this.$(\".upload-table\")[\n                    this.collection.length > 0 ? \"show\" : \"hide\"\n                ]();\n                upload_row.render();\n            },\n\n            /** Start upload process */\n            _eventStart: function() {\n                var self = this;\n                this.collection.each(function(model) {\n                    model.set({\n                        genome: self.select_genome.value(),\n                        extension: self.select_extension.value()\n                    });\n                });\n                $.uploadpost({\n                    url: this.app.options.nginx_upload_path,\n                    data: this.app.toData(this.collection.filter()),\n                    success: function(message) {\n                        self._eventSuccess(message);\n                    },\n                    error: function(message) {\n                        self._eventError(message);\n                    },\n                    progress: function(percentage) {\n                        self._eventProgress(percentage);\n                    }\n                });\n            },\n\n            /** Refresh progress state */\n            _eventProgress: function(percentage) {\n                this.collection.each(function(it) {\n                    it.set(\"percentage\", percentage);\n                });\n            },\n\n            /** Refresh success state */\n            _eventSuccess: function(message) {\n                this.collection.each(function(it) {\n                    it.set(\"status\", \"success\");\n                });\n                Galaxy.currHistoryPanel.refreshContents();\n            },\n\n            /** Refresh error state */\n            _eventError: function(message) {\n                this.collection.each(function(it) {\n                    it.set({ status: \"error\", info: message });\n                });\n            },\n\n            /** Load html template */\n            _template: function() {\n                return (\n                    '<div class=\"upload-view-composite\">' +\n                    '<div class=\"upload-top\">' +\n                    '<h6 class=\"upload-top-info\"/>' +\n                    \"</div>\" +\n                    '<div class=\"upload-box\">' +\n                    '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n                    \"<thead>\" +\n                    \"<tr>\" +\n                    \"<th/>\" +\n                    \"<th/>\" +\n                    \"<th>Description</th>\" +\n                    \"<th>Name</th>\" +\n                    \"<th>Size</th>\" +\n                    \"<th>Settings</th>\" +\n                    \"<th>Status</th>\" +\n                    \"</tr>\" +\n                    \"</thead>\" +\n                    \"<tbody/>\" +\n                    \"</table>\" +\n                    \"</div>\" +\n                    '<div class=\"upload-footer\">' +\n                    '<span class=\"upload-footer-title\">Composite Type:</span>' +\n                    '<span class=\"upload-footer-extension\"/>' +\n                    '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n                    '<span class=\"upload-footer-title\">Genome/Build:</span>' +\n                    '<span class=\"upload-footer-genome\"/>' +\n                    \"</div>\" +\n                    '<div class=\"upload-buttons\"/>' +\n                    \"</div>\"\n                );\n            }\n        });\n    }\n);\n"]}